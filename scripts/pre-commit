#!/bin/bash

# Pre-commit hook for gofer
set -e

echo "üîç Running pre-commit checks..."

# Check if go is installed
if ! command -v go &> /dev/null; then
    echo "‚ùå Go is not installed"
    exit 1
fi

# Check if golangci-lint is installed
if ! command -v golangci-lint &> /dev/null; then
    echo "‚ùå golangci-lint is not installed"
    echo "Install with: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b \$(go env GOPATH)/bin v1.54.2"
    exit 1
fi

# Get staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "‚úÖ No Go files staged, skipping checks"
    exit 0
fi

echo "üìù Staged Go files:"
echo "$STAGED_GO_FILES" | sed 's/^/  - /'

# Check go.mod and go.sum are in sync
echo "üîÑ Checking go.mod consistency..."
go mod tidy
if ! git diff --exit-code go.mod go.sum > /dev/null; then
    echo "‚ùå go.mod and go.sum are not in sync"
    echo "Please commit the changes to go.mod and go.sum"
    exit 1
fi

# Format check
echo "üé® Checking code formatting..."
UNFORMATTED_FILES=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED_FILES" ]; then
    echo "‚ùå The following files are not formatted:"
    echo "$UNFORMATTED_FILES" | sed 's/^/  - /'
    echo "Run 'gofmt -w <file>' to fix formatting"
    exit 1
fi

# Import check
echo "üì¶ Checking imports..."
if command -v goimports &> /dev/null; then
    IMPORT_ISSUES=$(goimports -l $STAGED_GO_FILES)
    if [ -n "$IMPORT_ISSUES" ]; then
        echo "‚ùå The following files have import issues:"
        echo "$IMPORT_ISSUES" | sed 's/^/  - /'
        echo "Run 'goimports -w <file>' to fix imports"
        exit 1
    fi
fi

# Lint check
echo "üîç Running linter..."
echo "$STAGED_GO_FILES" | xargs golangci-lint run

# Build check
echo "üèóÔ∏è  Checking build..."
go build ./...

# Test check
echo "üß™ Running tests..."
go test -timeout=30s ./...

# Security check (if gosec is available)
if command -v gosec &> /dev/null; then
    echo "üîí Running security scan..."
    gosec ./...
fi

echo "‚úÖ All pre-commit checks passed!"